<!DOCTYPE html>
<html>
<head>
  <title>File detail</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">

<h2 id="name"></h2>

<p>Status: <span id="status"></span></p>

<h5>Checks:</h5>
<pre id="result" class="bg-light p-3"></pre>

<button class="btn btn-warning" id="recheck">Recheck</button>
<button class="btn btn-danger" id="delete">Delete</button>

<!-- NEW: update file -->
<button class="btn btn-primary" id="updateBtn">Update file</button>
<input type="file" id="fileInput" style="display:none" />

<script src="app.js"></script>
<script>
const id = new URLSearchParams(window.location.search).get("id");

async function load() {
    const f = await api("/api/files/" + id + "/");

    document.getElementById("name").innerText = f.filename;
    document.getElementById("status").innerText = f.status;

    const resultEl = document.getElementById("result");

    if (f.checks && f.checks.length > 0) {
        const lines = f.checks.map((c, i) => {
            return (
                `#${f.checks.length - i}\n` +
                `Status: ${c.status}\n` +
                `Date: ${c.date}\n` +
                `Result: ${c.result || "(no result)"}\n` +
                `Email sent: ${c.email_sent ? "yes" : "no"}`
            );
        });

        resultEl.innerText = lines.join("\n\n-----------------------------\n\n");
    } else {
        resultEl.innerText = "(no checks)";
    }
}

document.getElementById("recheck").onclick = async () => {
    await api(`/api/files/${id}/rerun/`, "POST");
    window.location = "/files.html";
};

document.getElementById("delete").onclick = async () => {
    try {
        await api(`/api/files/${id}/`, "DELETE");
    } catch {}
    window.location = "/files.html";
};

/* ---------------------------------------------------------
    UPDATE FILE (PATCH)
--------------------------------------------------------- */

const updateBtn = document.getElementById("updateBtn");
const fileInput = document.getElementById("fileInput");

// нажали "Update file" → открыть выбор файла
updateBtn.onclick = () => {
    fileInput.click();
};

// выбрали файл → отправить форму
fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    await api(`/api/files/${id}/`, "PATCH", formData, true);

    alert("File updated!");
    load(); // перезагрузить данные
};

load();
</script>
</body>
</html>
